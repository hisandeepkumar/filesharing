<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 AirDropX - Cross-Platform File Transfer</title>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --background: #121212;
            --panel-bg: #1e1e1e;
            --text: #ffffff;
            --button-bg: #ffffff;
            --button-text: #000000;
            --glow-color: #ffffff;
            --glow: 0 0 10px var(--glow-color);
            --border: #ffffff;
            --primary: #ffffff;
            --success: #00ff00;
            --error: #ff0000;
            --warning: #ffff00;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        /* Animation Initial States */
        .fade-from-top { opacity: 0; transform: translateY(-50px); }
        .fade-from-bottom { opacity: 0; transform: translateY(50px); }
        .slide-from-left { opacity: 0; transform: translateX(-100%); }
        .slide-from-right { opacity: 0; transform: translateX(100%); }
        .slide-from-bottom { opacity: 0; transform: translateY(100%); }
        .animate-fade { opacity: 0; }

        /* Animation Triggers */
        body.loaded .fade-from-top { animation: fadeInDown 0.5s ease-out forwards; }
        body.loaded .fade-from-bottom { animation: fadeInUp 0.5s ease-out forwards; }
        body.loaded .slide-from-left { animation: slideInLeft 0.5s ease-out forwards; }
        body.loaded .slide-from-right { animation: slideInRight 0.5s ease-out forwards; }
        body.loaded .slide-from-bottom { animation: slideInBottom 0.5s ease-out forwards; }
        body.loaded .animate-fade { animation: fadeIn 0.3s ease-out forwards; animation-delay: var(--delay); }

        /* Keyframes */
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideInBottom { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Glowing Border Styles */
        .glow-border {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 40px;
            z-index: 1;
        }
        .glow-border::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            border-radius: 41px;
            background: linear-gradient(130deg, #ff0057, #ff7a00, #00ffe1, #ff00f2, #ff0057);
            background-size: 400%;
            animation: borderGlow 6s linear infinite;
            z-index: -1;
            filter: blur(5px);
        }
        .glow-border::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 40px;
            padding: 1px;
            background: linear-gradient(130deg, #ff0057, #ff7a00, #00ffe1, #ff00f2, #ff0057);
            background-size: 400%;
            animation: borderGlow 6s linear infinite;
            z-index: 1;
            -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
        }
        @keyframes borderGlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Panel and Panel Inner Styles */
        .panel {
            background: transparent; /* Panel ka background transparent rakha taki glowing border dikhe */
            padding: 2px; /* Border ke liye thodi space */
            border-radius: 40px;
        }

        .panel-inner {
            background-color: #000; /* Solid black background content ke liye */
            border-radius: 30px; /* Thoda chhota radius border ke andar fit hone ke liye */
            padding: 10px;
            position: relative;
            z-index: 2; /* Content border ke upar rahe */
        }

        /* Other styles remain the same */
        .header { text-align: center; margin: 20px 0 40px; }
        .logo { display: inline-flex; align-items: center; gap: 15px; margin-bottom: 20px; background: var(--panel-bg); padding: 15px 30px; border-radius: 20px; border: 1px solid var(--border); box-shadow: var(--glow); }
        h1 { font-size: 2.8rem; font-weight: 700; }
        .subtitle { font-size: 1.2rem; max-width: 600px; margin: 0 auto 30px; line-height: 1.6; }
        .container { max-width: 1300px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .panel-header { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        .panel-header i { font-size: 1.8rem; }
        h2 { font-size: 1.8rem; font-weight: 600; }
        .id-box { background: var(--panel-bg); padding: 18px; border-radius: 20px; margin: 20px 0; display: flex; align-items: center; gap: 12px; font-size: 1.1rem; border: 1px solid var(--border); box-shadow: var(--glow); }
        .id-box strong { font-weight: 600; flex-grow: 1; overflow: hidden; text-overflow: ellipsis; }
        .action-buttons { display: flex; gap: 10px; margin: 10px 0; }
        .btn { background: var(--button-bg); color: var(--button-text); border: none; padding: 14px 20px; border-radius: 20px; cursor: pointer; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 10px; font-size: 1rem; flex: 1; box-shadow: var(--glow); }
        .btn:hover { box-shadow: 0 0 20px var(--glow-color); }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text); box-shadow: var(--glow); }
        .btn-outline:hover { box-shadow: 0 0 20px var(--glow-color); }
        .btn-large { padding: 16px 24px; font-size: 1.1rem; }
        input { width: 100%; padding: 16px; border: 1px solid var(--border); border-radius: 20px; background: var(--panel-bg); color: var(--text); font-size: 1rem; margin: 15px 0; transition: all 0.3s; box-shadow: var(--glow); }
        input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 20px var(--glow-color); }
        .status-pill { display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; border-radius: 30px; font-size: 0.95rem; font-weight: 500; margin: 15px 0; width: 100%; justify-content: center; background: var(--panel-bg); border: 1px solid var(--border); box-shadow: var(--glow); }
        .status-pill.connected { color: var(--success); border-color: var(--success); }
        .status-pill.connecting { color: var(--warning); border-color: var(--warning); }
        .status-pill.disconnected, .status-pill.error { color: var(--error); border-color: var(--error); }
        .progress-container { margin: 20px 0; }
        .progress-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
        .progress { height: 12px; background: var(--panel-bg); border-radius: 10px; overflow: hidden; border: 1px solid var(--border); }
        .progress-bar { height: 100%; background: var(--primary); border-radius: 10px; transition: width 0.3s ease; }
        .qr-container { margin: 20px 0; text-align: center; background: var(--panel-bg); padding: 20px; border-radius: 20px; border: 1px solid var(--border); box-shadow: var(--glow); }
        #qrScanner, #senderScanner { width: 100%; height: 300px; background: var(--panel-bg); border-radius: 20px; margin: 15px 0; overflow: hidden; position: relative; border: 1px solid var(--border); box-shadow: var(--glow); }
        #senderScanner { display: none; }
        .scanner-frame { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; height: 70%; border: 3px solid var(--primary); border-radius: 12px; box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5); }
        .file-item { background: var(--panel-bg); padding: 18px; border-radius: 20px; margin: 15px 0; display: flex; align-items: center; gap: 15px; border: 1px solid var(--border); box-shadow: var(--glow); }
        .file-icon { font-size: 2rem; }
        .file-info { flex-grow: 1; }
        .file-name { font-weight: 500; margin-bottom: 5px; overflow: hidden; text-overflow: ellipsis; }
        .file-size { font-size: 0.9rem; }
        .notification { position: fixed; top: 30px; right: 30px; padding: 18px 25px; border-radius: 20px; background: var(--panel-bg); border: 1px solid var(--border); display: flex; align-items: center; gap: 15px; transform: translateX(150%); transition: transform 0.4s ease; box-shadow: var(--glow); }
        .notification.show { transform: translateX(0); }
        .notification i { font-size: 1.8rem; }
        .notification.success i { color: var(--success); }
        .notification.error i { color: var(--error); }
        .connection-stats { display: flex; justify-content: space-between; margin-top: 15px; font-size: 0.9rem; }
        .stats-item { display: flex; align-items: center; gap: 8px; }
        .stats-value { color: var(--primary); font-weight: 500; }
        .footer { text-align: center; margin-top: 50px; font-size: 0.9rem; padding: 20px; }
        .drop-zone { border: 2px dashed var(--border); border-radius: 20px; padding: 40px 20px; text-align: center; margin: 20px 0; transition: all 0.3s; background: var(--panel-bg); cursor: pointer; box-shadow: var(--glow); }
        .drop-zone:hover, .drop-zone.active { box-shadow: 0 0 20px var(--glow-color); }
        .drop-zone i { font-size: 3rem; margin-bottom: 15px; }
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } h1 { font-size: 2.2rem; } .panel { padding: 25px; } }
        @media (max-width: 600px) { body { padding: 15px; } h1 { font-size: 1.8rem; } h2 { font-size: 1.5rem; } .action-buttons { flex-direction: column; } .logo { padding: 12px 20px; } }
        .id-generating { display: inline-flex; align-items: center; gap: 10px; }
        .spinner { width: 20px; height: 20px; border: 3px solid var(--glow-color); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .connection-controls.hidden { display: none; }
        .disconnect-btn { background: transparent; color: var(--error); border: 2px solid var(--error); margin-top: 15px; box-shadow: var(--glow); }
        .disconnect-btn:hover { box-shadow: 0 0 20px var(--error); }
        .receiver-simplified { text-align: center; }
        .receiver-simplified .status-pill { margin-top: 30px; }
        .receiver-simplified .file-item { margin: 10px auto; max-width: 500px; }
        .receiver-simplified .progress-container { max-width: 500px; margin: 20px auto; }
        .receiver-simplified .connection-stats { justify-content: center; gap: 20px; }
    </style>
</head>
<body>
    <div class="header fade-from-top">
        <div class="logo animate-fade" style="--delay: 0.5s;">
            <i class="fas fa-paper-plane"></i>
            <h1>AirDropX</h1>
        </div>
        <p class="subtitle animate-fade" style="--delay: 0.6s;">Seamlessly transfer files between Android and iPhone devices. No installation required, works directly in your browser.</p>
    </div>
    
    <div class="container">
        <div class="panel glow-border slide-from-left">
            <div class="panel-inner">
                <div class="panel-header animate-fade" style="--delay: 0.5s;">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h2>Send Files</h2>
                </div>
                <div class="id-box animate-fade" style="--delay: 0.6s;">
                    <i class="fas fa-key"></i>
                    <strong id="myId"><span class="id-generating"><span class="spinner"></span> Generating your unique ID...</span></strong>
                    <button class="btn btn-outline slide-from-left" style="animation-delay: 0.7s;" onclick="copyID()"><i class="fas fa-copy"></i> Copy</button>
                </div>
                <div id="connectionStatusPill" class="status-pill disconnected animate-fade" style="--delay: 0.8s;"><i class="fas fa-circle"></i> ❌ Not connected</div>
                <div class="connection-controls animate-fade" id="senderConnectionControls" style="--delay: 0.9s;">
                    <div class="action-buttons">
                        <button class="btn btn-outline slide-from-left" style="animation-delay: 1.0s;" onclick="startSenderQRScanner()"><i class="fas fa-qrcode"></i> Scan QR</button>
                        <button class="btn btn-outline slide-from-right" style="animation-delay: 1.1s;" onclick="copyLink()"><i class="fas fa-link"></i> Copy Link</button>
                    </div>
                    <div class="qr-container animate-fade" id="senderQr" style="--delay: 1.2s;"></div>
                    <div id="senderScanner"><div class="scanner-frame"></div></div>
                    <input type="text" id="peerId" placeholder="📥 Enter Receiver ID (6-digit)" maxlength="6" class="animate-fade" style="--delay: 1.3s;">
                    <button class="btn btn-large slide-from-bottom" style="animation-delay: 1.4s;" onclick="connectPeer()"><i class="fas fa-plug"></i> Connect to Receiver</button>
                </div>
                <button id="disconnectBtn" class="btn btn-large disconnect-btn" onclick="disconnectPeer()" style="display: none;"><i class="fas fa-unlink"></i> Disconnect</button>
                <div class="drop-zone animate-fade" id="dropZone" style="--delay: 1.5s;"><i class="fas fa-cloud-upload-alt"></i><p>Drag & Drop files here</p><p class="hint">or click to select files</p></div>
                <input type="file" id="fileInput" multiple hidden>
                <div id="filePreview" style="margin: 20px 0;"></div>
                <button class="btn btn-large slide-from-bottom" style="animation-delay: 1.6s;" onclick="processFiles()"><i class="fas fa-paper-plane"></i> Send Files</button>
                <div class="progress-container animate-fade" style="--delay: 1.7s;">
                    <div class="progress-label"><span>Sending progress</span><span id="sendPercentage">0%</span></div>
                    <div class="progress"><div class="progress-bar" id="sendProgress" style="width: 0%"></div></div>
                </div>
                <div class="connection-stats animate-fade" style="--delay: 1.8s;">
                    <div class="stats-item"><i class="fas fa-microchip"></i> Connection: <span id="connType" class="stats-value">Establishing...</span></div>
                    <div class="stats-item"><i class="fas fa-bolt"></i> Speed: <span id="transferSpeed" class="stats-value">0 MB/s</span></div>
                </div>
            </div>
        </div>

        <div class="panel glow-border slide-from-right receiver-simplified">
            <div class="panel-inner">
                <div class="panel-header animate-fade" style="--delay: 0.5s;">
                    <i class="fas fa-cloud-download-alt"></i>
                    <h2>Receive Files</h2>
                </div>
                <div id="receiverStatusPill" class="status-pill animate-fade" style="--delay: 0.6s;"><i class="fas fa-circle"></i> 🟢 Ready to receive files</div>
                <div id="fileList" style="margin-top: 30px;"></div>
                <div class="progress-container animate-fade" style="--delay: 0.7s;">
                    <div class="progress-label"><span>Receiving progress</span><span id="receivePercentage">0%</span></div>
                    <div class="progress"><div class="progress-bar" id="receiveProgress" style="width: 0%"></div></div>
                </div>
                <div class="connection-stats animate-fade" style="--delay: 0.8s;">
                    <div class="stats-item"><i class="fas fa-wifi"></i> Status: <span id="receiveConnType" class="stats-value">Waiting...</span></div>
                    <div class="stats-item"><i class="fas fa-tachometer-alt"></i> Speed: <span id="receiveSpeed" class="stats-value">0 MB/s</span></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer fade-from-bottom">
        <p class="animate-fade" style="--delay: 0.5s;">AirDropX - Fast, secure, and cross-platform file transfers. No installation required.</p>
        <p class="animate-fade" style="--delay: 0.6s;">All data is transferred directly between devices - no servers involved.</p>
    </div>
    
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <div class="notification-content"><h3>Success!</h3><p>Your files have been sent successfully.</p></div>
    </div>

    <script>
        const CHUNK_SIZE = 64 * 1024 * 1024; // 64MB chunks for maximum speed
        const MAX_PARALLEL_CHUNKS = 30; // 30 chunks in parallel for faster transfer
        const AUTO_RECONNECT_DELAY = 3000;

        let peer = null, conn = null, peerId = null;
        const receivedFiles = new Map();
        let videoElement = null, senderScannerActive = false;
        let transferStats = { startTime: 0, bytesTransferred: 0 };
        let reconnectAttempts = 0, idGenerationAttempts = 0;

        function generateShortId() { return Math.floor(100000 + Math.random() * 900000).toString(); }

        function initializePeer() {
            const shortId = generateShortId();
            peer = new Peer(shortId, { config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:global.stun.twilio.com:3478' }, { urls: 'turn:numb.viagenie.ca', username: 'webrtc@live.com', credential: 'muazkh' }] } });
            peer.on('open', id => {
                peerId = id;
                document.getElementById('myId').innerHTML = `<span>${id}</span>`;
                generateQRCode(id);
                updateStatusPill('connectionStatusPill', 'Ready to connect', '');
                updateStats('connType', 'Peer established');
                const urlParams = new URLSearchParams(window.location.search);
                const connectTo = urlParams.get('connect');
                if (connectTo) { document.getElementById('peerId').value = connectTo; setTimeout(() => connectPeer(), 500); }
            });
            peer.on('error', err => {
                console.error('Peer Error:', err);
                if (err.type === 'unavailable-id' && idGenerationAttempts < 5) { idGenerationAttempts++; setTimeout(initializePeer, 500); }
                else { showNotification(`Error: ${err.type}`, 'error'); updateStatusPill('connectionStatusPill', `Error: ${err.type}`, 'error'); if (err.type === 'peer-unavailable' || err.type === 'network') setTimeout(initializePeer, AUTO_RECONNECT_DELAY); }
            });
            peer.on('connection', connection => {
                conn = connection;
                setupConnection(connection);
                showNotification('Receiver connected!', 'success');
                updateStatusPill('receiverStatusPill', 'Connected to sender', 'connected');
                updateStats('receiveConnType', 'Connected');
            });
            peer.on('disconnected', () => {
                updateStatusPill('connectionStatusPill', 'Connection lost. Reconnecting...', 'disconnected');
                setTimeout(initializePeer, AUTO_RECONNECT_DELAY);
            });
        }

        function connectPeer() {
            const connectTo = document.getElementById('peerId').value.trim();
            if (!connectTo) { showNotification('Please enter a receiver ID', 'error'); updateStatusPill('connectionStatusPill', 'Enter receiver ID', 'error'); return; }
            if (connectTo.length !== 6) { showNotification('ID must be 6 digits', 'error'); return; }
            updateStatusPill('connectionStatusPill', 'Connecting to receiver...', 'connecting');
            conn = peer.connect(connectTo, { reliable: true, serialization: 'binary', metadata: { type: 'sender' } });
            conn.on('open', () => { setupConnection(conn); showNotification('Connected to receiver!', 'success'); updateStats('connType', 'P2P connected'); });
            conn.on('error', err => {
                console.error('Connection Error:', err);
                showNotification(`Connection error: ${err.message}`, 'error');
                updateStatusPill('connectionStatusPill', `Error: ${err.message}`, 'error');
                toggleConnectionControls(false);
                reconnectAttempts++;
                if (reconnectAttempts <= 3) setTimeout(() => connectPeer(), AUTO_RECONNECT_DELAY);
            });
        }

        function setupConnection(connection) {
            connection.on('data', handleIncomingData);
            connection.on('close', () => {
                showNotification('Connection closed', 'error');
                updateStatusPill('connectionStatusPill', 'Disconnected', 'disconnected');
                updateStatusPill('receiverStatusPill', 'Disconnected', 'disconnected');
                updateStats('receiveConnType', 'Disconnected');
                toggleConnectionControls(false);
            });
            updateStatusPill('connectionStatusPill', `Connected to ${connection.peer.substring(0, 8)}...`, 'connected');
            reconnectAttempts = 0;
            updateStats('connType', 'P2P connected');
            toggleConnectionControls(true);
            vibrateDevice();
        }

        function vibrateDevice() { try { if (navigator.vibrate) navigator.vibrate([100, 50, 100]); } catch (e) { console.log("Vibration not supported"); } }

        function toggleConnectionControls(connected) {
            const controls = document.getElementById('senderConnectionControls');
            const disconnectBtn = document.getElementById('disconnectBtn');
            if (connected) { controls.classList.add('hidden'); disconnectBtn.style.display = 'block'; }
            else { controls.classList.remove('hidden'); disconnectBtn.style.display = 'none'; }
        }

        function disconnectPeer() {
            if (conn) { conn.close(); conn = null; }
            updateStatusPill('connectionStatusPill', 'Disconnected', 'disconnected');
            toggleConnectionControls(false);
            updateStatusPill('receiverStatusPill', 'Ready to receive files', '');
            updateStats('receiveConnType', 'Disconnected');
        }

        function updateStatusPill(elementId, text, status) {
            const pill = document.getElementById(elementId);
            if (!pill) return;
            pill.className = `status-pill ${status}`;
            let icon = status === 'connected' ? '🔗' : status === 'connecting' ? '🔄' : status === 'error' ? '⚠️' : '❌';
            pill.innerHTML = `<i class="fas fa-circle"></i> ${icon} ${text}`;
        }

        async function processFiles() {
            if (!conn || !conn.open) { showNotification('Not connected to receiver', 'error'); return; }
            const files = document.getElementById('fileInput').files;
            if (!files.length) { showNotification('Please select files first', 'error'); return; }
            try {
                transferStats.startTime = Date.now();
                transferStats.bytesTransferred = 0;
                for (const file of files) await transferFile(file);
                showNotification('All files sent successfully!', 'success');
            } catch(err) { showNotification(`Error: ${err.message}`, 'error'); }
        }

        async function transferFile(file) {
            const fileId = Date.now() + '-' + Math.random().toString(36).slice(2, 8);
            const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
            conn.send({ type: 'metadata', id: fileId, name: file.name, size: file.size, mime: file.type, totalChunks });
            createFilePreview(file, fileId);
            const chunks = Array.from({length: totalChunks}, (_, i) => i);
            while(chunks.length) {
                const batch = chunks.splice(0, MAX_PARALLEL_CHUNKS);
                await Promise.all(batch.map(i => sendChunk(file, i, fileId)));
                const transferred = totalChunks - chunks.length;
                const progress = Math.min(100, (transferred / totalChunks) * 100);
                updateProgress('sendProgress', progress);
                document.getElementById('sendPercentage').textContent = `${Math.round(progress)}%`;
                updateTransferSpeed();
            }
        }

        async function sendChunk(file, index, fileId) {
            return new Promise(resolve => {
                const reader = new FileReader();
                const start = index * CHUNK_SIZE;
                const end = Math.min(start + CHUNK_SIZE, file.size);
                const chunk = file.slice(start, end);
                reader.onload = () => {
                    conn.send({ type: 'chunk', id: fileId, index, data: reader.result });
                    transferStats.bytesTransferred += chunk.size;
                    resolve();
                };
                reader.readAsArrayBuffer(chunk);
            });
        }

        function handleIncomingData(data) {
            if (data.type === 'metadata') handleMetadata(data);
            if (data.type === 'chunk') handleChunk(data);
        }

        function handleMetadata(meta) {
            receivedFiles.set(meta.id, { name: meta.name, chunks: new Array(meta.totalChunks), received: 0, size: meta.size, mime: meta.mime, startTime: Date.now() });
            addFileToList(meta);
        }

        function handleChunk(chunk) {
            const file = receivedFiles.get(chunk.id);
            if (!file) return;
            file.chunks[chunk.index] = chunk.data;
            file.received += chunk.data.byteLength;
            const progress = Math.min(100, (file.received / file.size) * 100);
            updateFileProgress(chunk.id, progress);
            updateProgress('receiveProgress', progress);
            document.getElementById('receivePercentage').textContent = `${Math.round(progress)}%`;
            updateReceiveSpeed(file);
            if (file.received >= file.size) { finalizeFile(file); updateStats('receiveSpeed', 'Complete'); }
        }

        function generateQRCode(id) {
            document.getElementById('senderQr').innerHTML = '';
            new QRCode(document.getElementById('senderQr'), { text: id, width: 180, height: 180, colorDark: "#ffffff", colorLight: "transparent", correctLevel: QRCode.CorrectLevel.H });
        }

        function startSenderQRScanner() {
            if (senderScannerActive) { stopSenderQRScanner(); return; }
            senderScannerActive = true;
            const qrDiv = document.getElementById('senderQr');
            const scannerDiv = document.getElementById('senderScanner');
            qrDiv.style.display = 'none';
            scannerDiv.style.display = 'block';
            document.querySelector('.btn-outline .fa-qrcode').parentNode.innerHTML = '<i class="fas fa-times"></i> Cancel Scan';
            startCamera(scannerDiv, true);
        }

        function stopSenderQRScanner() {
            senderScannerActive = false;
            const qrDiv = document.getElementById('senderQr');
            const scannerDiv = document.getElementById('senderScanner');
            qrDiv.style.display = 'block';
            scannerDiv.style.display = 'none';
            document.querySelector('.btn-outline .fa-times').parentNode.innerHTML = '<i class="fas fa-qrcode"></i> Scan QR';
            if (videoElement && videoElement.srcObject) { videoElement.srcObject.getTracks().forEach(track => track.stop()); scannerDiv.removeChild(videoElement); videoElement = null; }
        }

        function startCamera(container, isSender) {
            if (videoElement) { container.appendChild(videoElement); requestAnimationFrame(() => scanQR(isSender)); return; }
            videoElement = document.createElement('video');
            container.appendChild(videoElement);
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(stream => {
                videoElement.srcObject = stream;
                videoElement.setAttribute("playsinline", true);
                videoElement.play();
                requestAnimationFrame(() => scanQR(isSender));
            }).catch(err => {
                console.error('Camera error:', err);
                showNotification('Camera access required for scanning', 'error');
                if (isSender) stopSenderQRScanner();
            });
        }

        function scanQR(isSender) {
            if (!videoElement || videoElement.readyState !== 4) { requestAnimationFrame(() => scanQR(isSender)); return; }
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(videoElement, 0, 0);
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code) {
                if (isSender) { stopSenderQRScanner(); document.getElementById('peerId').value = code.data; connectPeer(); }
                showNotification('QR code scanned successfully!', 'success');
            } else { requestAnimationFrame(() => scanQR(isSender)); }
        }

        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            dropZone.addEventListener('click', () => fileInput.click());
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, preventDefaults, false));
            function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
            ['dragenter', 'dragover'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.add('active'), false));
            ['dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.remove('active'), false));
            dropZone.addEventListener('drop', (e) => { const dt = e.dataTransfer; const files = dt.files; handleFiles(files); }, false);
            fileInput.addEventListener('change', () => handleFiles(fileInput.files));
        }

        function handleFiles(files) {
            if (!files.length) return;
            const dataTransfer = new DataTransfer();
            for (let i = 0; i < files.length; i++) dataTransfer.items.add(files[i]);
            document.getElementById('fileInput').files = dataTransfer.files;
            const preview = document.getElementById('filePreview');
            preview.innerHTML = '';
            for (const file of files) {
                const fileId = Date.now() + '-' + Math.random().toString(36).slice(2, 8);
                createFilePreview(file, fileId);
            }
            showNotification(`${files.length} file(s) selected`, 'success');
        }

        function createFilePreview(file, fileId) {
            const preview = document.getElementById('filePreview');
            const div = document.createElement('div');
            div.className = 'file-item';
            div.id = `file-preview-${fileId}`;
            const fileType = file.type.split('/')[0];
            let icon = 'file';
            if (fileType === 'image') icon = 'file-image';
            else if (fileType === 'video') icon = 'file-video';
            else if (fileType === 'audio') icon = 'file-audio';
            else if (file.type.includes('pdf')) icon = 'file-pdf';
            div.innerHTML = `<i class="fas fa-${icon} file-icon"></i><div class="file-info"><div class="file-name">${file.name}</div><div class="file-size">${formatFileSize(file.size)}</div></div><div class="progress" style="width: 100px; margin-left: 10px;"><div class="progress-bar" style="width: 0%"></div></div>`;
            preview.appendChild(div);
            return div;
        }

        function addFileToList(meta) {
            const fileList = document.getElementById('fileList');
            const div = document.createElement('div');
            div.className = 'file-item';
            div.id = `file-${meta.id}`;
            const fileType = meta.mime.split('/')[0];
            let icon = 'file';
            if (fileType === 'image') icon = 'file-image';
            else if (fileType === 'video') icon = 'file-video';
            else if (fileType === 'audio') icon = 'file-audio';
            else if (meta.mime.includes('pdf')) icon = 'file-pdf';
            div.innerHTML = `<i class="fas fa-${icon} file-icon"></i><div class="file-info"><div class="file-name">${meta.name}</div><div class="file-size">${formatFileSize(meta.size)}</div></div><div class="progress" style="width: 100px"><div class="progress-bar" style="width: 0%"></div></div>`;
            fileList.appendChild(div);
        }

        function updateFileProgress(fileId, progress) {
            const elem = document.querySelector(`#file-${fileId} .progress-bar`);
            if (elem) {
                elem.style.width = `${progress}%`;
                elem.parentElement.previousElementSibling.querySelector('.file-size').textContent = `${Math.round(progress)}% • ${formatFileSize(receivedFiles.get(fileId).received)} / ${formatFileSize(receivedFiles.get(fileId).size)}`;
            }
        }

        function updateProgress(barId, percent) { document.getElementById(barId).style.width = `${percent}%`; }

        function copyID() {
            if (!peerId) return;
            navigator.clipboard.writeText(peerId).then(() => showNotification('ID copied to clipboard!', 'success')).catch(err => {
                const textArea = document.createElement('textarea');
                textArea.value = peerId;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('ID copied to clipboard!', 'success');
            });
        }

        function copyLink() {
            if (!peerId) { showNotification('ID not generated yet', 'error'); return; }
            const link = `${window.location.origin}${window.location.pathname}?connect=${peerId}`;
            navigator.clipboard.writeText(link).then(() => showNotification('Shareable link copied!', 'success'));
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            const icon = notification.querySelector('i');
            const title = notification.querySelector('h3');
            const content = notification.querySelector('p');
            title.textContent = type === 'success' ? 'Success!' : 'Error!';
            content.textContent = message;
            if (type === 'success') { icon.className = 'fas fa-check-circle'; notification.style.borderLeft = `4px solid var(--success)`; }
            else { icon.className = 'fas fa-exclamation-circle'; notification.style.borderLeft = `4px solid var(--error)`; }
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        function updateTransferSpeed() {
            const elapsed = (Date.now() - transferStats.startTime) / 1000;
            if (elapsed < 0.1) return;
            const bytesPerSec = transferStats.bytesTransferred / elapsed;
            const speed = bytesPerSec / (1024 * 1024);
            updateStats('transferSpeed', `${speed.toFixed(2)} MB/s`);
        }

        function updateReceiveSpeed(file) {
            const elapsed = (Date.now() - file.startTime) / 1000;
            if (elapsed < 0.1) return;
            const bytesPerSec = file.received / elapsed;
            const speed = bytesPerSec / (1024 * 1024);
            updateStats('receiveSpeed', `${speed.toFixed(2)} MB/s`);
        }

        function updateStats(elementId, value) { const elem = document.getElementById(elementId); if (elem) elem.textContent = value; }

        function finalizeFile(file) {
            const blob = new Blob(file.chunks, { type: file.mime });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = file.name;
            link.click();
            showNotification(`File "${file.name}" downloaded!`, 'success');
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + ' MB';
            else return (bytes / 1073741824).toFixed(1) + ' GB';
        }

        window.addEventListener('load', function() { initializePeer(); setupDragAndDrop(); document.getElementById('peerId').addEventListener('input', function() { const id = this.value.trim(); if (id.length === 6) connectPeer(); }); });
        document.addEventListener('DOMContentLoaded', function() { setTimeout(() => document.body.classList.add('loaded'), 100); });
    </script>
</body>
</html>
