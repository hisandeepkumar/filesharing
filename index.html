<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ AirDropX Ultra</title>
    
    <!-- Libraries -->
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <style>
        /* Basic Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Theme Variables */
        :root {
            --green: #00ff88;  /* Hara rang */
            --blue: #0066ff;   /* Neela rang */
            --background: #0a1929; /* Background color */
        }

        body {
            background: var(--background);
            color: white;
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        /* Dono Panels ke liye common styling */
        .panel {
            background: #001e3c99;
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid var(--green);
            box-shadow: 0 0 20px var(--green);
        }

        /* ID Display Box */
        .id-box {
            background: #002850;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Buttons Styling */
        button {
            background: linear-gradient(to right, var(--green), var(--blue));
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s;
            margin: 10px 0;
            width: 100%;
        }

        button:hover {
            transform: scale(1.02);
            box-shadow: 0 0 15px var(--green);
        }

        /* QR Code Container */
        .qr-box {
            margin: 20px 0;
            padding: 15px;
            background: #002850;
            border-radius: 10px;
            text-align: center;
        }

        /* Progress Bar */
        .progress-bar {
            height: 10px;
            background: #003362;
            border-radius: 5px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress {
            height: 100%;
            background: linear-gradient(to right, var(--green), var(--blue));
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center; margin-bottom: 30px;">üöÄ AirDropX Ultra</h1>
    
    <div class="container">
        <!-- Sender Panel -->
        <div class="panel">
            <h2>üì§ Send Files</h2>
            
            <!-- Your ID Section -->
            <div class="id-box">
                <span>üîë Your ID:</span>
                <strong id="myId">Generating...</strong>
                <button onclick="copyID()">üìã Copy</button>
            </div>

            <!-- QR Code Display -->
            <div class="qr-box" id="qrDisplay"></div>

            <!-- Connection Controls -->
            <input type="text" id="peerId" placeholder="Enter Receiver ID">
            <button onclick="connectToPeer()">üîó Connect Karein</button>
            
            <!-- File Selection -->
            <input type="file" id="fileInput" hidden multiple>
            <button onclick="document.getElementById('fileInput').click()">
                üìÅ Files Chunein
            </button>
            <button onclick="startTransfer()">üöÄ Transfer Shuru Karein</button>

            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress" id="sendProgress" style="width: 0%"></div>
            </div>
        </div>

        <!-- Receiver Panel -->
        <div class="panel">
            <h2>üì• Receive Files</h2>
            
            <!-- Scan Section -->
            <div class="id-box">
                <span>üì° Status:</span>
                <span id="connectionStatus">Ready</span>
            </div>
            <button onclick="startQRScanner()">üì∑ QR Scan Karein</button>
            <div id="qrScanner" style="display: none;"></div>

            <!-- Received Files List -->
            <div id="fileList"></div>

            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress" id="receiveProgress" style="width: 0%"></div>
            </div>
        </div>
    </div>

<script>
// PeerJS connection setup
let peer = null;
let conn = null;

// Initialize PeerJS connection
async function initializePeer() {
    try {
        peer = new Peer({
            host: '0.peerjs.com',  // Public PeerJS server
            port: 443,
            secure: true,
            debug: 3
        });

        // Jab peer ID mil jaye
        peer.on('open', (id) => {
            console.log('Apka Peer ID:', id);
            document.getElementById('myId').textContent = id;
            generateQRCode(id);  // QR code banaye
        });

        // Connection aane par
        peer.on('connection', (connection) => {
            conn = connection;
            setupConnection(connection);
        });

    } catch (error) {
        console.error('PeerJS mein error:', error);
        setTimeout(initializePeer, 3000);  // 3 second baad phir try karein
    }
}

// QR code generate karne ka function
function generateQRCode(id) {
    try {
        const qrDiv = document.getElementById('qrDisplay');
        qrDiv.innerHTML = '';  // Purana QR hatao
        
        // Naya QR banayo
        new QRCode(qrDiv, {
            text: id,
            width: 200,
            height: 200,
            colorDark: "#00ff88",
            colorLight: "#001e3c",
            correctLevel: QRCode.CorrectLevel.H
        });
    } catch (error) {
        console.error('QR generate nahi ho paaya:', error);
    }
}

// File transfer logic
async function startTransfer() {
    const files = document.getElementById('fileInput').files;
    if(files.length === 0) return alert('Pehle files chunein!');

    // Har file ko process karein
    for(const file of files) {
        const fileSize = file.size;
        const chunkSize = 256 * 1024;  // 256KB chunks
        const totalChunks = Math.ceil(fileSize / chunkSize);

        // Metadata send karein
        conn.send({
            type: 'metadata',
            fileName: file.name,
            fileSize: file.size,
            totalChunks: totalChunks
        });

        // Chunks ko send karein
        for(let i=0; i<totalChunks; i++) {
            const start = i * chunkSize;
            const end = Math.min(start + chunkSize, fileSize);
            const chunk = file.slice(start, end);
            
            // Chunk ko send karein
            conn.send({
                type: 'chunk',
                index: i,
                data: chunk
            });

            // Progress update karein
            const progress = ((i+1)/totalChunks)*100;
            document.getElementById('sendProgress').style.width = `${progress}%`;
        }
    }
}

// QR Scanner chalane ka function
function startQRScanner() {
    const video = document.createElement('video');
    const scannerDiv = document.getElementById('qrScanner');
    scannerDiv.style.display = 'block';
    
    // Camera access mangain
    navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
        video.srcObject = stream;
        video.play();
        
        // QR scan karte rahein
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        function scanFrame() {
            if(video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if(code) {
                    document.getElementById('peerId').value = code.data;
                    connectToPeer();
                    scannerDiv.style.display = 'none';
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
            }
            requestAnimationFrame(scanFrame);
        }
        scanFrame();
    })
    .catch(err => {
        console.error('Camera access nahi mila:', err);
        alert('Camera access dena padega!');
    });
}

// Initialize karein jab page load ho
window.addEventListener('load', () => {
    initializePeer();
    if(navigator.serviceWorker) {
        navigator.serviceWorker.register('/service-worker.js')
            .then(() => console.log('Service Worker registered!'))
            .catch(err => console.error('Service Worker error:', err));
    }
});
</script>

</body>
</html>
