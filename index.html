<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code-Based WebRTC Signaling</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background-color: #121212; color: white; }
        button, input { padding: 10px; font-size: 16px; margin: 5px; background-color: #333; color: #fff; border: none; cursor: pointer; }
        input { width: 80%; text-align: center; background-color: #222; border: 1px solid #555; color: white; }
        #fileTransfer { display: none; }
    </style>
</head>
<body onload="generateOfferCode()">
    <h2>WebRTC P2P Connection</h2>

    <p><b>Offer Code:</b></p>
    <input type="text" id="offerCode" readonly>
    <button onclick="copyOfferCode()">Copy Code</button>

    <p><b>Enter Offer Code:</b></p>
    <input type="text" id="inputOfferCode" placeholder="Paste Offer Code Here" oninput="generateAnswerCode()">

    <p><b>Answer Code:</b></p>
    <input type="text" id="answerCode" readonly>
    <button onclick="copyAnswerCode()">Copy Code</button>

    <p><b>Enter Answer Code:</b></p>
    <input type="text" id="inputAnswerCode" placeholder="Paste Answer Code Here" oninput="connectWithAnswer()">

    <div id="fileTransfer">
        <input type="file" id="fileInput">
        <button onclick="sendFile()">Send File</button>
    </div>

    <p id="status"></p>
    <p>Received File: <a id="downloadLink" download="received_file">Download</a></p>

    <script>
        let peerConnection;
        let dataChannel;
        let isConnected = false;

        const rtcConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

        function generateOfferCode() {
            peerConnection = new RTCPeerConnection(rtcConfig);
            dataChannel = peerConnection.createDataChannel("fileChannel");

            dataChannel.onopen = () => showFileTransferUI();
            dataChannel.onmessage = event => receiveFile(event.data);

            peerConnection.createOffer().then(offer => {
                return peerConnection.setLocalDescription(offer);
            }).then(() => {
                document.getElementById("offerCode").value = btoa(JSON.stringify(peerConnection.localDescription));
            });
        }

        function generateAnswerCode() {
            let encodedOffer = document.getElementById("inputOfferCode").value;
            if (!encodedOffer) return;

            let sdp;
            try {
                sdp = JSON.parse(atob(encodedOffer));
            } catch (e) {
                return;
            }

            peerConnection = new RTCPeerConnection(rtcConfig);

            peerConnection.ondatachannel = event => {
                dataChannel = event.channel;
                dataChannel.onopen = () => showFileTransferUI();
                dataChannel.onmessage = event => receiveFile(event.data);
            };

            peerConnection.setRemoteDescription(new RTCSessionDescription(sdp)).then(() => {
                return peerConnection.createAnswer();
            }).then(answer => {
                return peerConnection.setLocalDescription(answer);
            }).then(() => {
                document.getElementById("answerCode").value = btoa(JSON.stringify(peerConnection.localDescription));
            });
        }

        function connectWithAnswer() {
            if (isConnected) return; // Agar already connected hai to kuch mat karo
            
            let encodedAnswer = document.getElementById("inputAnswerCode").value;
            if (!encodedAnswer) return;

            let sdp;
            try {
                sdp = JSON.parse(atob(encodedAnswer));
            } catch (e) {
                return;
            }

            peerConnection.setRemoteDescription(new RTCSessionDescription(sdp)).then(() => {
                isConnected = true; // Connection establish hone ke baad flag set kar do
                document.getElementById("status").innerText = "Connected!";
                navigator.vibrate(500);
                document.getElementById("fileTransfer").style.display = "block";

                // Dono mobiles me "Connected" show karne ke liye event listener add karo
                peerConnection.onconnectionstatechange = () => {
                    if (peerConnection.connectionState === "connected") {
                        document.getElementById("status").innerText = "Connected!";
                        navigator.vibrate(500);
                        document.getElementById("fileTransfer").style.display = "block";
                    }
                };
            });
        }

        function copyOfferCode() {
            let offerCode = document.getElementById("offerCode");
            offerCode.select();
            document.execCommand("copy");
        }

        function copyAnswerCode() {
            let answerCode = document.getElementById("answerCode");
            answerCode.select();
            document.execCommand("copy");
        }

        function showFileTransferUI() {
            document.getElementById("status").innerText = "Connected!";
            navigator.vibrate(500);
            document.getElementById("fileTransfer").style.display = "block";
        }

        function sendFile() {
            const file = document.getElementById("fileInput").files[0];
            if (!file) return alert("Select a file first!");

            const reader = new FileReader();
            reader.onload = () => {
                if (dataChannel.readyState === "open") {
                    dataChannel.send(reader.result);
                    document.getElementById("status").innerText = "File sent!";
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function receiveFile(data) {
            const blob = new Blob([data]);
            const url = URL.createObjectURL(blob);
            const link = document.getElementById("downloadLink");
            link.href = url;
            link.style.display = "inline";
            document.getElementById("status").innerText = "File received!";
        }
    </script>
</body>
</html>
